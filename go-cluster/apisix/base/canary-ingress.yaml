# Canary Ingress for Argo Rollouts
# This ingress is used by Argo Rollouts for canary deployments
# Normal traffic goes through APISIX, this is only for rollout traffic splitting

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: canary-ingress
  namespace: app
  annotations:
    kubernetes.io/ingress.class: apisix
spec:
  ingressClassName: apisix
  tls:
  - hosts:
    - app.go-cinch.top
    - vue3.go-cinch.top
    - ocr.go-cinch.top
    - react.go-cinch.top
    - asynqmon.go-cinch.top
    - yolo.go-cinch.top
    secretName: canary-ingress-tls
  rules:
  # Vue3 Frontend
  - host: vue3.go-cinch.top
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: vue3
            port:
              number: 80
  # OCR Vue3 Frontend
  - host: ocr.go-cinch.top
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ocr-vue3
            port:
              number: 80
  # React Frontend
  - host: react.go-cinch.top
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: react
            port:
              number: 80
  # Asynqmon Frontend
  - host: asynqmon.go-cinch.top
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: asynqmon
            port:
              number: 80
  # YOLO Frontend
  - host: yolo.go-cinch.top
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: yolo
            port:
              number: 80
  # Auth API
  - host: app.go-cinch.top
    http:
      paths:
      - path: /api/auth
        pathType: Prefix
        backend:
          service:
            name: auth
            port:
              number: 80
      # OSS API
      - path: /api/oss
        pathType: Prefix
        backend:
          service:
            name: oss
            port:
              number: 80
      # OCR API
      - path: /api/ocr
        pathType: Prefix
        backend:
          service:
            name: ocr
            port:
              number: 80
